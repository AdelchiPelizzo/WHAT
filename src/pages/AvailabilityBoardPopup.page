<apex:page controller="AvailabilityService" showHeader="false" sidebar="false" cache="false">
    <apex:slds />
    <!-- CometD Scripts -->
    <apex:includeScript value="{!URLFOR($Resource.cometd)}" />
    <apex:includeScript value="{!URLFOR($Resource.ackExtension)}" />
    <apex:includeScript value="{!URLFOR($Resource.replayExtension)}" />
    <head>
        <link rel="stylesheet" href="https://unpkg.com/@salesforce-ux/design-system@latest/assets/styles/salesforce-lightning-design-system.min.css" />
    </head>

    <apex:stylesheet value="{!URLFOR($Resource.globalBoardStyles)}" />

    <script>

        var cometd = new org.cometd.CometD();

        function initCometD() {
            cometd.configure({
                url: window.location.protocol + '//' + window.location.hostname + '/cometd/54.0/',
                requestHeaders: { Authorization: 'OAuth {!$Api.Session_ID}' },
            appendMessageTypeToURL: false
        });

        cometd.websocketEnabled = false;

        cometd.handshake(function (handshakeReply) {
            if (handshakeReply.successful) {
                console.log('CometD handshake successful');

                cometd.subscribe('/data/adelwhat__User_Availability__ChangeEvent', function (message) {
                    console.log('CDC event received:', message);
                    var payload = message.data.payload;
                    var changeHeader = payload.ChangeEventHeader;
                    var recordIds = changeHeader.recordIds;

                    if (!recordIds || recordIds.length === 0) {
                        console.warn('No recordIds found in ChangeEventHeader');
                        return;
                    }

                    var availabilityId = recordIds[0];
                    var newStatus = payload.adelwhat__Status__c;

                    console.log('Updating availabilityId:', availabilityId, 'to status:', newStatus);

                    var row = document.querySelector('tr[data-availability-id="' + availabilityId + '"]');

                    if (row) {
                        var badge = row.querySelector('.status-badge');

                        if (badge) {
                            badge.className = 'status-badge';

                            switch (newStatus) {
                                case 'ACTIVE':
                                    badge.classList.add('in');
                                    break;
                                case 'INACTIVE':
                                    badge.classList.add('out');
                                    break;
                                case 'PAUSE':
                                    badge.classList.add('at-lunch');
                                    break;
                                case 'OOO':
                                    badge.classList.add('ooo');
                                    break;
                                default:
                                    break;
                            }

                            var flipboard = badge.querySelector('.flipboard');
                            if (flipboard) {
                                flipboard.innerHTML = '';
                                [...newStatus].forEach((letter, index) => {
                                    const cell = document.createElement('div');
                                    cell.className = 'flip-cell';

                                    const span = document.createElement('span');
                                    // Set the previous letter, or fallback to letter if first load
                                    span.textContent = letter;

                                    cell.appendChild(span);
                                    flipboard.appendChild(cell);

                                    setTimeout(() => {
                                        void cell.offsetWidth;

                                        cell.classList.add('flipping');

                                        setTimeout(() => {
                                            span.textContent = letter; // Confirm new letter post-flip
                                            cell.classList.remove('flipping');
                                        }, 400);
                                    }, index * 100);
                                });
                            } else {
                                console.warn('No flipboard element found inside badge');
                            }
                        }
                    } else {
                        console.warn('No table row found for availabilityId:', availabilityId);
                    }
                });
            } else {
                console.error('CometD handshake failed');
            }
        });
    }
    document.addEventListener('DOMContentLoaded', function () {
        initCometD();
    });
    </script>

    <body>
    <div class="slds-scope">
        <div class="" id="board">
            <apex:form >
                <h2 class="slds-text-heading_medium">Team Availability Board</h2>
                <div>
                    <table >
                        <thead >
                        <tr >
                            <th style="padding-left: 20px;" >First Name</th>
                            <th style="padding-left: 20px;">Last Name</th>
                            <th style="padding-left: 20px;">Status</th>
                            <th style="padding-left: 20px;">User Id</th>
                        </tr>
                        </thead>
                        <tbody >
                            <apex:repeat value="{!availabilityList}" var="a">
                                <tr id="row-{!a.userRecordId}" class="slds-form-element"
                                    data-user-id="{!a.userRecordId}"
                                    data-availability-id="{!a.availabilityId}">
                                    <td class="slds-text-heading_medium" style="padding-left: 20px;">{!a.userFirstName}</td>
                                    <td class="slds-text-heading_medium" style="padding-left: 20px;">{!a.userLastName}</td>
                                    <td style="padding-left: 20px;">
                                        <span class="status-badge
                                            {!IF(a.Status = 'ACTIVE', 'in', '')}
                                            {!IF(a.Status = 'INACTIVE', 'out', '')}
                                            {!IF(a.Status = 'PAUSE', 'at-lunch', '')}
                                            {!IF(a.Status = 'OOO', 'ooo', '')}">

                                            <!-- Flipboard Style Status Rendering -->
                                            <div class="flipboard">
                                                <apex:repeat value="{!a.statusLetters}" var="letter">
                                                    <div class="flip-cell">{!letter}</div>
                                                </apex:repeat>
                                            </div>
                                        </span>
                                    </td>
                                    <td class="slds-text-heading_medium" style="padding-left: 20px;">{!a.userRecordId}</td>
                                </tr>
                        </apex:repeat>
                        </tbody>
                    </table>
                </div>
                <button class="close-btn" onclick="window.close(); return false;">Close</button>
            </apex:form>
        </div>
    </div>
    </body>
</apex:page>